#!/bin/sh

SCRIPT=$(readlink -f "$0")
SCRIPTPATH=$(dirname "$SCRIPT")

export LD_LIBRARY_PATH="${SCRIPTPATH}/headunit_libs:/jci/lib:/jci/opera/3rdpartylibs/freetype:/usr/lib/imx-mm/audio-codec:/usr/lib/imx-mm/parser:/data_persist/dev/lib:"
#override some GST plugins with these
export GST_PLUGIN_PATH="${SCRIPTPATH}/headunit_libs:/usr/lib/gstreamer-0.10"

conf='{
    "launchOnDevice": true,
    "carGPS": true,
    "wifiTransport": false
}'

if ! [ -e /tmp/root/headunit.json ]; then
 echo $conf > /tmp/root/headunit.json
fi

while [ true ]; do
 #Check online
 count=`ip route|grep default|grep wlan0|wc -l`
 if [ $count -ge 1 ]; then
  touch /tmp/root/online.status
  stable_count=$(( $stable_count + 1 ))
  if [ $stable_count -gt $stable_threshold ]; then
   touch /tmp/root/online-stable.status
   stable_count=$(( $stable_threshold + 1 ))
  fi
 else
  stable_count=0
  rm -f /tmp/root/online.status
  rm -f /tmp/root/online-stable.status
 fi
 # Check personal hotspot
 android_netcheck=`netstat -rn|awk '$2=="192.168.43.1" {print}'|wc -l`
 
 #AA-Wifi
 if [ -e /tmp/root/online.status ]&&[ $android_netcheck == 1 ]; then
  if ! [ -e /tmp/root/headunit-wireless.status ]; then
   sed -i 's."wifiTransport": false."wifiTransport": true.g' /tmp/root/headunit.json 
   taskset 0xFFFFFFFF "${SCRIPTPATH}/headunit" "$@" 2>&1 | tee /tmp/mnt/data/headunit.log
   touch /tmp/root/headunit-wireless.status
   rm -f  /tmp/root/headunit.status
   echo "First start"
  fi
 else ## AA-USB
  killall headunit ||true
  if ! [ -e /tmp/root/headunit.status ]; then
   sed -i 's."wifiTransport": true."wifiTransport": false.g' /tmp/root/headunit.json 
   taskset 0xFFFFFFFF "${SCRIPTPATH}/headunit" "$@" 2>&1 | tee /tmp/mnt/data/headunit.log
   touch /tmp/root/headunit.status
   rm -f /tmp/root/headunit-wireless.status
  fi
 fi
 RAND=`expr $RANDOM % 5`
 echo "go sleep $RAND"
 sleep $RAND
done
